C51 COMPILER V9.54   TEMP                                                                  11/16/2017 10:50:11 PAGE 1   


C51 COMPILER V9.54, COMPILATION OF MODULE TEMP
OBJECT MODULE PLACED IN .\Objects\temp.obj
COMPILER INVOKED BY: D:\MDK\C51\BIN\C51.EXE temp.c LARGE OPTIMIZE(8,SPEED) BROWSE DEBUG OBJECTEXTEND PRINT(.\Listings\te
                    -mp.lst) TABS(2) OBJECT(.\Objects\temp.obj)

line level    source

   1          //****************************************
   2          // Update to MPU6050 by shinetop
   3          // MCU: STC89C52
   4          // 2012.3.1
   5          // 1|?ü: ??ê??ó?ù?è??oííó?Yò?µ?10???-ê?êy?Y
   6          //****************************************
   7          // GY-52 MPU3050 IIC2aê?3ìDò
   8          // ê1ó?µ????úSTC89C51 
   9          // ?§???o11.0592M
  10          // ??ê??oLCD12864
  11          // ±àò??·?3 Keil uVision2
  12          // 2???oê?§í???24c04í¨D?3ìDò
  13          // ê±???o2011?ê9??1è?
  14          // QQ?o531389319
  15          // sbit CE    =P1^0;                              /*  RX/TX??ê???????       */
  16          // sbit CSN   =P1^1;                              /*  SPI??????             */
  17          // sbit SCLK  =P1^2;                              /*  SPIê±?ó??             */
  18          // sbit MOSI  =P1^3;                              /*  SPI?÷?úê?3?'ó?úê?è??? */
  19          // sbit MISO  =P1^4;                              /*  SPI?÷?úê?3?'ó?úê?3??? */
  20          // sbit IRQ   =P1^5;
  21          //****************************************
  22          #include <REG52.H>  
  23          #include <math.h>    //Keil library  
  24          #include <stdio.h>   //Keil library 
  25          #include <INTRINS.H>
  26          #include "nrf24l01.h"
*** WARNING C318 IN LINE 26 OF temp.c: can't open file 'nrf24l01.h'
  27          
  28          //typedef unsigned char  uchar;
  29          //typedef unsigned short ushort;
  30          //typedef unsigned int   uint;
  31          //****************************************
  32          // ?¨ò?51µ????ú???ú
  33          //****************************************
  34          #define DataPort P0     //LCD12864êy?Y???ú
  35          sbit    LED=P2^0;       //LEDD?o?ê?·?·??íêy?Y3é1|
  36          sbit    SCL=P2^6;       //IICê±?óòy???¨ò?
  37          sbit    SDA=P2^7;       //IICêy?Yòy???¨ò?
  38          sbit LCD12864_RS  =  P2^3;             //?¨êy?Y?üá?????'??÷????ê?è? 
  39          sbit LCD12864_RW  =  P2^5;             //òo?§?á/D'????
  40          sbit LCD12864_EN  =  P2^4;             //òo?§ê1?ü????
  41          sbit LCD12864_PSB =  P3^2;             //'?/2?·?ê?????
  42          sbit LCD12864_RST =  P3^4;             //?'????
  43          //****************************************
  44          // ?¨ò?MPU6050?ú2?µ??·
  45          //****************************************
  46          #define SMPLRT_DIV    0x19  //íó?Yò?2é?ù?ê??µ?Dí?µ?o0x07(125Hz)
  47          #define CONFIG        0x1A  //µíí¨??2¨?µ?ê??µ?Dí?µ?o0x06(5Hz)
  48          #define GYRO_CONFIG   0x1B  //íó?Yò?×??ì?°2aá?·??§??µ?Dí?µ?o0x18(2?×??ì??2000deg/s)
  49          #define ACCEL_CONFIG  0x1C  //?ó?ù??×??ì??2aá?·??§?°??í¨??2¨?µ?ê??µ?Dí?µ?o0x01(2?×??ì??2G??5Hz)
  50          #define ACCEL_XOUT_H  0x3B
  51          #define ACCEL_XOUT_L  0x3C
  52          #define ACCEL_YOUT_H  0x3D
  53          #define ACCEL_YOUT_L  0x3E
C51 COMPILER V9.54   TEMP                                                                  11/16/2017 10:50:11 PAGE 2   

  54          #define ACCEL_ZOUT_H  0x3F
  55          #define ACCEL_ZOUT_L  0x40
  56          #define TEMP_OUT_H    0x41
  57          #define TEMP_OUT_L    0x42
  58          #define GYRO_XOUT_H   0x43
  59          #define GYRO_XOUT_L   0x44  
  60          #define GYRO_YOUT_H   0x45
  61          #define GYRO_YOUT_L   0x46
  62          #define GYRO_ZOUT_H   0x47
  63          #define GYRO_ZOUT_L   0x48
  64          #define PWR_MGMT_1    0x6B     //µ??'1üàí??µ?Dí?µ?o0x00(?y3???ó?)
  65          #define WHO_AM_I      0x75     //IICµ??·??'??÷(??è?êy?µ0x68?????á)
  66          #define SlaveAddress  0xD0     //IICD'è?ê±µ?µ??·×??úêy?Y??+1?a?áè?
  67          //****************************************
  68          //?¨ò?ààDí?°±?á?
  69          //****************************************
  70          uchar dis[4];                 //??ê?êy×?(-511?á512)µ?×?·?êy×é
*** ERROR C129 IN LINE 70 OF temp.c: missing ';' before 'dis'
  71          char qian,you,zuo,hou,ting;
  72          int dis_data;                //±?á?
  73           char tx_qian[4]={0x05,0x05,0x05,0x05};    //±?D?ê?4??êy×é
  74           char tx_you[4]={0x01,0x01,0x01,0x01};
  75           char tx_zuo[4]={0x04,0x04,0x04,0x04};
  76           char tx_hou[4]={0x0a,0x0a,0x0a,0x0a};
  77           char tx_ting[4]={0x00,0x00,0x00,0x00};
  78          //int Temperature,Temp_h,Temp_l;         //???è?°??µí??êy?Y
  79          //****************************************
  80          //o¯êyéù?÷
  81          //****************************************
  82          void  delay(unsigned int k);             //?óê±
  83          //LCD?à1?o¯êy
  84          void  InitLcd();                          //3?ê??¯lcd12864
  85          void  lcd_printf(uchar *s,int temp_data);
  86          void  WriteDataLCM(uchar dataW);                        //LCDêy?Y
  87          void  WriteCommandLCM(uchar CMD,uchar Attribc);         //LCD??á?
  88          void  DisplayOneChar(uchar X,uchar Y,uchar DData);      //??ê?ò???×?·?
  89          void  DisplayListChar(uchar X,uchar Y,uchar *DData,L);  //??ê?×?·?'?y
  90          void  InitMPU6050();                                    //3?ê??¯MPU6050
  91          void  Delay5us();
  92          void  I2C_Start();
  93          void  I2C_Stop();
  94          void  I2C_SendACK(bit ack);
  95          bit   I2C_RecvACK();
  96          void  I2C_SendByte(uchar dat);
  97          uchar I2C_RecvByte();
  98          void  I2C_ReadPage();
  99          void  I2C_WritePage();
 100          void  display_ACCEL_x();
 101          void  display_ACCEL_y();
 102          void  display_ACCEL_z();
 103          uchar Single_ReadI2C(uchar REG_Address);                  //?áè?I2Cêy?Y
 104          void  Single_WriteI2C(uchar REG_Address,uchar REG_data);  //?òI2CD'è?êy?Y
 105          //****************************************
 106          //??êy×a×?·?'?
 107          //****************************************
 108          void Delay10ms()    //@12.000MHz
 109          {
 110            unsigned char i, j;
 111          
 112            i = 117;
 113            j = 184;
 114            do
C51 COMPILER V9.54   TEMP                                                                  11/16/2017 10:50:11 PAGE 3   

 115            {
 116              while (--j);
 117            } while (--i);
 118          }
 119          
 120          
 121          
 122          void lcd_printf(uchar *s,int temp_data)
 123          {
 124            if(temp_data<0)
 125            {
 126            
 127                temp_data=-temp_data;
 128                *s='-';
 129            }
 130            else *s=' ';
 131            *++s =temp_data/100+0x30;
 132            temp_data=temp_data%100;     //è?óà????
 133            *++s =temp_data/10+0x30;
 134            temp_data=temp_data%10;      //è?óà????
 135            *++s =temp_data+0x30;   
 136          }
 137          //****************************************
 138          //?óê±
 139          //****************************************
 140          void delay(unsigned int k)  
 141          {           
 142            unsigned int i,j;       
 143            for(i=0;i<k;i++)
 144            {     
 145              for(j=0;j<121;j++);
 146            }           
 147          }
 148          //****************************************
 149          //LCD128643?ê??¯
 150          //****************************************
 151          void InitLcd()        
 152          {     
 153            WriteCommandLCM(0x38,1);  
 154            WriteCommandLCM(0x08,1);  
 155            WriteCommandLCM(0x01,1);  
 156            WriteCommandLCM(0x06,1);  
 157            WriteCommandLCM(0x0c,1);
 158            DisplayOneChar(0,0,'A');
 159            //DisplayOneChar(0,1,'G');
 160          }     
 161          //****************************************
 162          //LCD12864D'?êDí
 163          //****************************************
 164          void WaitForEnable(void)  
 165          {         
 166            DataPort=0xff;    
 167            LCD12864_RS=0;
 168            LCD12864_RW=1;
 169            _nop_();
 170            LCD12864_EN=1;
 171            _nop_();
 172            _nop_();
 173            while(DataPort&0x80); 
 174            LCD12864_EN=0;        
 175          }         
 176          //****************************************
C51 COMPILER V9.54   TEMP                                                                  11/16/2017 10:50:11 PAGE 4   

 177          //LCD1602D'è??üá?
 178          //****************************************
 179          void WriteCommandLCM(uchar CMD,uchar Attribc)
 180          {         
 181            if(Attribc)WaitForEnable(); 
 182            LCD12864_RS=0;
 183            LCD12864_RW=0;
 184            _nop_();
 185            DataPort=CMD;
 186            _nop_();  
 187            LCD12864_EN=1;
 188            _nop_();
 189            _nop_();
 190            LCD12864_EN=0;
 191          }         
 192          //****************************************
 193          //LCD1602D'è?êy?Y
 194          //****************************************
 195          void WriteDataLCM(uchar dataW)
 196          {         
 197            WaitForEnable();    
 198            LCD12864_RS=1;
 199            LCD12864_RW=0;
 200            _nop_();
 201            DataPort=dataW;
 202            _nop_();  
 203            LCD12864_EN =1;
 204            _nop_();
 205            _nop_();
 206            LCD12864_EN =0;
 207          }   
 208          //****************************************
 209          //LCD1602D'è?ò???×?·?
 210          //****************************************
 211          void DisplayOneChar(uchar X,uchar Y,uchar DData)
 212          {           
 213            Y&=1;           
 214            X&=15;            
 215            if(Y)X|=0x40;         
 216            X|=0x80;      
 217            WriteCommandLCM(X,0);   
 218            WriteDataLCM(DData);    
 219          }           
 220          //****************************************
 221          //LCD1602??ê?×?·?'?
 222          //****************************************
 223          void DisplayListChar(uchar X,uchar Y,uchar *DData,L)
 224          {
 225            uchar ListLength=0; 
 226            Y&=0x1;                
 227            X&=0xF;                
 228            while(L--)             
 229            {                       
 230              DisplayOneChar(X,Y,DData[ListLength]);
 231              ListLength++;  
 232              X++;                        
 233            }    
 234          }
 235          //**************************************
 236          //?óê±5????(STC90C52RC@12M)
 237          //2?í?µ?1¤×÷?·?3,Dèòaµ÷??'?o¯êy
 238          //µ±??ó?1Tµ?MCUê±,??µ÷??'??óê±o¯êy
C51 COMPILER V9.54   TEMP                                                                  11/16/2017 10:50:11 PAGE 5   

 239          //**************************************
 240          void Delay5us()
 241          {
 242            _nop_();_nop_();_nop_();_nop_();
 243            _nop_();_nop_();_nop_();_nop_();
 244            _nop_();_nop_();_nop_();_nop_();
 245            _nop_();_nop_();_nop_();_nop_();
 246            _nop_();_nop_();_nop_();_nop_();
 247            _nop_();_nop_();_nop_();_nop_();
 248          }
 249          //**************************************
 250          //I2C?eê?D?o?
 251          //**************************************
 252          void I2C_Start()
 253          {
 254              SDA = 1;                    //à-??êy?Y??
 255              SCL = 1;                    //à-??ê±?ó??
 256              Delay5us();                 //?óê±
 257              SDA = 0;                    //2úéú???µ??
 258              Delay5us();                 //?óê±
 259              SCL = 0;                    //à-µíê±?ó??
 260          }
 261          //**************************************
 262          //I2Cí??1D?o?
 263          //**************************************
 264          void I2C_Stop()
 265          {
 266              SDA = 0;                    //à-µíêy?Y??
 267              SCL = 1;                    //à-??ê±?ó??
 268              Delay5us();                 //?óê±
 269              SDA = 1;                    //2úéúé?éy??
 270              Delay5us();                 //?óê±
 271          }
 272          //**************************************
 273          //I2C·??íó|'eD?o?
 274          //è??ú2?êy:ack (0:ACK 1:NAK)
 275          //**************************************
 276          void I2C_SendACK(bit ack)
 277          {
 278              SDA = ack;                  //D'ó|'eD?o?
 279              SCL = 1;                    //à-??ê±?ó??
 280              Delay5us();                 //?óê±
 281              SCL = 0;                    //à-µíê±?ó??
 282              Delay5us();                 //?óê±
 283          }
 284          //**************************************
 285          //I2C?óê?ó|'eD?o?
 286          //**************************************
 287          bit I2C_RecvACK()
 288          {
 289              SCL = 1;                    //à-??ê±?ó??
 290              Delay5us();                 //?óê±
 291              CY  = SDA;                  //?áó|'eD?o?
 292              SCL = 0;                    //à-µíê±?ó??
 293              Delay5us();                 //?óê±
 294              return CY;
 295          }
 296          //**************************************
 297          //?òI2C×ü??·??íò???×??úêy?Y
 298          //**************************************
 299          void I2C_SendByte(uchar dat)
 300          {
C51 COMPILER V9.54   TEMP                                                                  11/16/2017 10:50:11 PAGE 6   

 301              uchar i;
 302              for (i=0; i<8; i++)         //8????êy?÷
 303              {
 304                  dat <<= 1;              //ò?3?êy?Yµ?×?????
 305                  SDA = CY;               //?íêy?Y?ú
 306                  SCL = 1;                //à-??ê±?ó??
 307                  Delay5us();             //?óê±
 308                  SCL = 0;                //à-µíê±?ó??
 309                  Delay5us();             //?óê±
 310              }
 311              I2C_RecvACK();
 312          }
 313          //**************************************
 314          //'óI2C×ü???óê?ò???×??úêy?Y
 315          //**************************************
 316          uchar I2C_RecvByte()
 317          {
 318              uchar i;
 319              uchar dat = 0;
 320              SDA = 1;                    //ê1?ü?ú2?é?à-,×?±??áè?êy?Y,
 321              for (i=0; i<8; i++)         //8????êy?÷
 322              {
 323                  dat  <<= 1;
 324                  SCL    = 1;             //à-??ê±?ó??
 325                  Delay5us();             //?óê±
 326                  dat |= SDA;             //?áêy?Y               
 327                  SCL    = 0;             //à-µíê±?ó??
 328                  Delay5us();             //?óê±
 329              }
 330              return dat;
 331          }
 332          //**************************************
 333          //?òI2Céè±?D'è?ò???×??úêy?Y
 334          //**************************************
 335          void Single_WriteI2C(uchar REG_Address,uchar REG_data)
 336          {
 337              I2C_Start();                  //?eê?D?o?
 338              I2C_SendByte(SlaveAddress);   //·??íéè±?µ??·+D'D?o?
 339              I2C_SendByte(REG_Address);    //?ú2???'??÷µ??·??
 340              I2C_SendByte(REG_data);       //?ú2???'??÷êy?Y??
 341              I2C_Stop();                   //·??íí??1D?o?
 342          }
 343          //**************************************
 344          //'óI2Céè±??áè?ò???×??úêy?Y
 345          //**************************************
 346          uchar Single_ReadI2C(uchar REG_Address)
 347          {
 348            uchar REG_data;
 349            I2C_Start();                   //?eê?D?o?
 350            I2C_SendByte(SlaveAddress);    //·??íéè±?µ??·+D'D?o?
 351            I2C_SendByte(REG_Address);     //·??í'?'?µ??aµ??·??'ó0?aê?  
 352            I2C_Start();                   //?eê?D?o?
 353            I2C_SendByte(SlaveAddress+1);  //·??íéè±?µ??·+?áD?o?
 354            REG_data=I2C_RecvByte();       //?á3???'??÷êy?Y
 355            I2C_SendACK(1);                //?óê?ó|'eD?o?
 356            I2C_Stop();                    //í??1D?o?
 357            return REG_data;
 358          }
 359          //**************************************
 360          //3?ê??¯MPU6050
 361          //**************************************
 362          void InitMPU6050()
C51 COMPILER V9.54   TEMP                                                                  11/16/2017 10:50:11 PAGE 7   

 363          {
 364            Single_WriteI2C(PWR_MGMT_1, 0x00);  //?a3yDY??×'ì?
 365            Single_WriteI2C(SMPLRT_DIV, 0x07);
 366            Single_WriteI2C(CONFIG, 0x06);
 367            Single_WriteI2C(GYRO_CONFIG, 0x18);
 368            Single_WriteI2C(ACCEL_CONFIG, 0x01);
 369          }
 370          //**************************************
 371          //o?3éêy?Y
 372          //**************************************
 373          int GetData(uchar REG_Address)
 374          {
 375            char H,L;
 376            H=Single_ReadI2C(REG_Address);
 377            L=Single_ReadI2C(REG_Address+1);
 378            return (H<<8)+L;               //o?3éêy?Y
 379          }
 380          //**************************************
 381          //?ú12864é???ê?10??êy?Y
 382          //**************************************
 383          void Display10BitData(int value,uchar x,uchar y)
 384          {
 385            value/=64;                  //×a???a10??êy?Y
 386            lcd_printf(dis, value);     //×a??êy?Y??ê?
 387            DisplayListChar(x,y,dis,4); //??ê?áD??DD????ê?êy×é????ê?3¤?è
 388          }
 389          //**************************************
 390          //??ê????è
 391          //**************************************
 392          //void display_temp()
 393          //{ 
 394          //  Temp_h=Single_ReadI2C(TEMP_OUT_H); //?áè????è
 395          //  Temp_l=Single_ReadI2C(TEMP_OUT_L); //?áè????è
 396          //  Temperature=Temp_h<<8|Temp_l;     //o?3é???è
 397          //  Temperature = 35+ ((double) (Temperature + 13200)) / 280; // ????3????è
 398          //  lcd_printf(dis,Temperature);     //×a??êy?Y??ê?
 399          //  DisplayListChar(11,1,dis,4);     //??ê?áD??DD????ê?êy×é????ê???êy
 400          //}
 401          //*********************************************************
 402          //?÷3ìDò
 403          //*********************************************************
 404          void main()
 405          {
 406              
 407            
 408            //InitLcd();    //òo?§3?ê??¯
 409            InitMPU6050();  //3?ê??¯MPU6050
 410            NRF24L01Int();
 411            delay(150);
 412            while(1)
 413            {
 414              you=qian=zuo=hou=ting=0;
 415              LED = 0;
 416          //    Display10BitData(GetData(ACCEL_XOUT_H),2,0);   //??ê?X??
 417          //    Display10BitData(GetData(ACCEL_YOUT_H),7,0);   //??ê?Y??
 418          //    Display10BitData(GetData(ACCEL_ZOUT_H),12,0);  //??ê?Z??
 419          //    Display10BitData(GetData(GYRO_XOUT_H),2,1);    //??ê?X?á???ù?è
 420          //    Display10BitData(GetData(GYRO_YOUT_H),7,1);    //??ê?Y?á???ù?è
 421          //    Display10BitData(GetData(GYRO_ZOUT_H),12,1);   //??ê?Z?á???ù?è
 422              if((GetData(ACCEL_ZOUT_H)/64)>=200)  qian = 1;   //x
 423              if((GetData(ACCEL_YOUT_H)/64)>=120)  zuo  = 1;   //y
 424              if((GetData(ACCEL_XOUT_H)/64)>=240)  ting = 1;   //z
C51 COMPILER V9.54   TEMP                                                                  11/16/2017 10:50:11 PAGE 8   

 425              if((GetData(ACCEL_ZOUT_H)/64)<=-150) hou  = 1;   //x
 426              if((GetData(ACCEL_YOUT_H)/64)<=-200) you  = 1;   //y
 427              
 428              if (you == 1)
 429                 {
 430                  NRFSetTxMode(tx_qian);
 431                  while    (CheckACK());
 432                   LED = 1;
 433                  }
 434               if (qian == 1)
 435                    {       
 436                  NRFSetTxMode(tx_you); 
 437                  while   (CheckACK());        //?D??êy?Yê?·?·??ííê3é
 438                      LED = 1;
 439                    }
 440                if (hou == 1)
 441                    {
 442                  NRFSetTxMode(tx_zuo);
 443                  while   (CheckACK());
 444                      LED = 1;
 445                    }
 446              if (ting == 1)
 447                  {       
 448                  NRFSetTxMode(tx_ting);      
 449                  while    (CheckACK());
 450                    LED = 1;
 451                  }
 452                if (zuo == 1)
 453                  {       
 454                  NRFSetTxMode(tx_hou);     
 455                  while   (CheckACK());
 456                    LED = 1;
 457                  }
 458                  
 459          
 460              delay(50);
 461            }
 462          }

C51 COMPILATION COMPLETE.  1 WARNING(S),  1 ERROR(S)
